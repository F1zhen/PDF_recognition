# Digital Document Inspector

Детекция штампов, подписей и QR-кодов в сканах документов

**Хакатон:** InnovateX 2025 x ARMETA.AI 
**Команда:** OnlyFriends

---

## Быстрый запуск inference (получение JSON + визуализации)

Если вам нужно просто запустить инференс и получить итоговый JSON без запуска backend, используйте встроенный скрипт:

### 1. Положите PDF-файлы в:
```
data/input_pdfs/
```

Например:
```
data/input_pdfs/document1.pdf
```

### 2. Запустите инференс:
```bash
python -m main_infer --pdf data/input_pdfs/
```

Можно указать конкретный файл:
```bash
python -m main_infer --pdf data/input_pdfs/document1.pdf
```

### 3. Результаты сохраняются автоматически

**JSON с детекциями:**
```
data/outputs/json/predictions.json
```

**PNG-визуализации для каждой страницы:**
```
data/outputs/viz/_page_0001_viz.png
```

Инференс полностью автономный — он сам:
- читает PDF
- конвертирует в изображения
- запускает EnsembleDetector
- делает crop-детекции
- применяет NMS
- сохраняет итоговый JSON

---

## Описание проекта

Digital Document Inspector — это решение для автоматического анализа документов (сканов, фотографий, PDF), которое умеет:

- **Находить штампы**
- **Находить подписи**
- **Находить QR-коды / штрихкоды**
- **Находить подписи, которые находятся внутри печатей**
- **Генерировать целевой JSON-формат для проверки документов**

**Особенность решения** — двухэтапная детекция подписи, позволяющая находить подписи даже тогда, когда они:
- нарисованы поверх печати
- частично закрыты текстурой печати
- плохо видны на исходном документе

Это ключевой кейс, который обычные YOLO-модели не решают.

---

## Архитектура решения

### 1. Детектор штампов (StampDetector)
- YOLOv8-модель, обученная только на штампах
- Используется как локализатор областей, внутри которых может находиться подпись

### 2. Детектор подписи (два режима)

У нас есть две стратегии детекции подписи:

| Детектор | Где работает | Зачем |
|----------|--------------|-------|
| signature_global | на всей странице | находит обычные подписи |
| signature_in_stamp | на crop-патчах штампа | находит тонкие подписи внутри печатей |

Благодаря этому мы ловим подписи, которые просвечивают через печать.

### 3. Детектор QR / штрихкода (QrDetector)
- YOLO-модель для QR и barcode

### 4. Ensemble-агрегатор (EnsembleDetector)

Объединяет три модели и отвечает за post-processing:
- Собирает результат всех детекторов
- Делает crop-детекцию внутри печатей
- Выполняет NMS по классам
- Ставит флаг `"stamp_with_signature": true`, если подпись пересекает печать
- Приводит к единому JSON-формату

---

## Pipeline распознавания
```
PDF → split на страницы → PNG → EnsembleDetector → JSON + визуализация
```

**Под капотом:**

**Шаг 1.** Детектируем штампы, подписи и QR-коды на всей странице:
```python
sigs_global = signature_global.predict()
stamps = stamp.predict()
qrs = qr.predict()
```

**Шаг 2.** Для каждой печати → делаем crop  
Извлекаем прямоугольник области штампа.

**Шаг 3.** На этом crop'е запускаем второй SignatureDetector  
Это увеличивает относительный размер подписи и убирает лишний шум.

**Шаг 4.** Склеиваем подписи из:
- глобального детектора
- crop-детектора
- Применяем NMS

**Шаг 5.** Сохраняем JSON + PNG-визуализацию

---

## Backend / ML: установка зависимостей

Рекомендуется использовать виртуальное окружение:
```bash
python -m venv venv

# Linux/Mac
source venv/bin/activate

# Windows
venv\Scripts\activate
```

Установка зависимостей (если requirements.txt уже есть):
```bash
pip install -r requirements.txt
```

Если файла requirements.txt нет, зависимости можно установить вручную (см. список ниже).

---

## Запуск backend / ML-сервиса

1. Активировать виртуальное окружение (см. выше)
2. Перейти в директорию backend/ (если есть отдельная папка) или в корень проекта, где лежит main.py FastAPI-приложения
3. Запустить Uvicorn на порту 8089:
```bash
uvicorn app:app --host 0.0.0.0 --port 8089
```

После этого backend будет доступен по адресу:
```
http://localhost:8089
```

Фронтенд может обращаться к этому порту для инференса ML.

---

## Запуск фронтенда

Перейти в папку фронта:
```bash
cd frontend
```

Установить зависимости (первый запуск):
```bash
npm install
```

Запустить dev-сервер:
```bash
npm run dev
```

По умолчанию фронт будет доступен на `http://localhost:5173` (или другом порту, который выдает Vite/Next и т.д., в зависимости от стека).

---

## Формат выходного JSON

Пример:
```json
{
  "document1.pdf": {
    "page_1": {
      "size": [2480, 3508],
      "detections": [
        {
          "category": "stamp",
          "bbox": [345, 820, 510, 510],
          "score": 0.92,
          "stamp_with_signature": true
        },
        {
          "category": "signature",
          "bbox": [430, 900, 300, 120],
          "score": 0.38,
          "source": "signature_in_stamp"
        },
        {
          "category": "qr",
          "bbox": [1900, 3100, 350, 350],
          "score": 0.88
        }
      ]
    }
  }
}
```

---

## Зависимости (requirements.txt)
```
ultralytics==8.3.0
numpy
opencv-python
pillow
pymupdf          
pyyaml
torch
fastapi
uvicorn
python-multipart
tqdm
```


## Ключевые особенности алгоритма

**1. Двухуровневая детекция подписи**  
Если обычная YOLO подпись внутри печати не видит - crop-детектор её увидит.

**2. Поддержка слабых подписей**  
На crop-детекторе используем меньший порог уверенности (например, 0.10).

**3. Корректная работа с "шумными" печатями**  
Печать не мешает, потому что мы смотрим на локальный фрагмент.

**4. Чистый JSON и флаг "stamp_with_signature"**  
Важно для проверок подлинности документов.

## Контакты команды

@F1zhen — ML

@x_ae_yedil — Back-End

@batyr_sk — Front-End



